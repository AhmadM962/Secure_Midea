import os
import logging
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from fastapi.middleware.cors import CORSMiddleware
from openai import OpenAI

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["POST"],
    allow_headers=["*"],
)

OPENAI_API_KEY = ""
client = OpenAI(api_key=OPENAI_API_KEY)

logger = logging.getLogger("uvicorn.error")

class CommentRequest(BaseModel):
    text: str

SYSTEM_INSTRUCTIONS = """
You are an Arabic-language social media comment classifier for political conflict detection in Jordan.

Your task is to analyze a comment and decide:

Return 1 if the comment is politically sensitive or inciting conflict.
Return 0 if the comment is neutral, personal, or unrelated to politics.

Mark as Political (1) if the comment:
- Tries to provoke conflict between Jordanians and Palestinians in Jordan
- Criticizes the Jordanian government, army, monarchy, or its support for Palestine
- Uses or promotes terms like "ุชุทุจูุน" (normalization with Israel) or attacks Jordan's political stance
- Makes offensive or divisive comments about Jordanian regions (e.g., Irbid, Amman)
- Uses phrases like "ุงุญูุง ุงูู ุนูุฑูุงูุง" in a political or sarcastic tone
- Includes political slurs like: "ุจูุงุฌูู", "ุจุฑูุทุงูููู", "ุจูุฏูุฑุฉ" in a political context

Mark as Non-Political (0) if the comment:
- Is a joke, compliment, or normal conversation
- Talks about lifestyle, celebrities, food, sports, or daily life
- Expresses emotion, praise, or general opinions unrelated to Jordan's politics

Always respond with only a single digit: 1 or 0.
If unsure, default to 0.

example of commints :
Not Political | 8 ุณ ุญุจุงูุจูุง ุงูุงุฑุฏููู 
Not Political | ุงูุงุฑุฏู ูููุณุทูู ุฑุงุญุฏ ูุงุญุฏ ูุงุญุฏ
Not Political | ููุณุทูู ุญุฑุฉ 
Political | ูู ุงูุจูุฏุงู ุงูุบุฑุจูู ุชุฑูุน ุนูู ููุณุทูู ุจูู ูุฎุฑ ...ุงูุนุฑุจ ๐ท
Not Political | ููุณุชูุฑูู ๐๐ฅ
Political | ููุด ูุง ุจุชุฑูุนูุง ุนูู ููุณุทูู ูุซูุง
Not Political | ูุงุฎูุฑุง ุฑุฌุนุช
Not Political | ุงูุงุฑุฏู ูููุณุทูู ููู ูุงุญุฏ
Not Political | ููุจุง ููุงูุจุง ุงุญูุง ูุงุญุฏ
Political | ูุงุงุงู ุนูู ููุณุทูู ูุด ุนุงุฑููู ุชุฑูุนูู ูุง ุงููู ููู ูุตูุชู ูุง ุงููู
Political | ููุณู ุงุนุจุฑ ูู ุฏูู ูุง ุงุฎุงู ูู ุงูุฌุฑุงุฆู ุงูุฅููุชุฑูููุฉ ูู ุงูุงุฑุฏู ูุงุธ ูุงูุง ูู ูุทุฑ ููุง ุจุงูู ุงููู ูู ุงูุงุฑุฏู !!!!  ูุง ูุฌุน ููุจู ูุง ุบุฒุฉ
Not Political | Dari Malaysia, Palestine dan Jordan, Allahu Akbar 
Political | ููุง ูุงู ุงุจู ุงุจุฑุงูููุ ุงููู ุนุงุฌุจู ุนุงุฌุจูุ ุงุณุชูุฑุฑูุง โ๐ผ๐๐๐ฅ
Not Political | ๐ต๐ธ๐ต๐ธ๐ต๐ธ๐ต๐ธ๐ต๐ธ๐ต๐ธ๐๐๐ุงูููู ูุตุฑู ููุฑุฌู ุงููุฑูุจ ูุงุฑุจ
Political | ููุงุฐุง ูุฑูุน ุนูู ููุณุทูู ูู ุงูุฑูุจุง ููููุน ุฑูุนู ูู ุงูุงุฑุฏู ููู ูุณูููู ุ ููุงุฐุง ุงูุงูุจุทุงุญ ูููููุฏ
Political | ููุงู ุฑุณุงูุฉ ุฎุงุตุฉ ูู ุงูุนุฏู ูุฌุจ ุฃู ุชุตู ููุฏ ูุตูุช ุ ูู ุชุฑุถู .... ููุชูู
 Political | 5 ุฃ ููุฏุฑุฌุฉ ุบุงุธูู ุจูุงู ุงูุญุฑูุฉ ุงููู ุจุชุดุฑู
Not Political | 5 ุฃ ุจุชุชุณุฌูู ุจุงูุชุงุฑูุฎ ูุงู ุง.
Not Political | 5 ุฃ ุงูุญูุฏ ููู ุนูู ูุนูุฉ ููู ุงูููุงูุฉ
Not Political | 5 ุฃ ุงูุญูุฏููู ุนูู ูุนูุฉ ููู ุงูููุงูุฉ
Not Political | 5 ุฃ ุณูุงุฏุฉ ุงูุงุฑุฏู ููู ูู ุดู 
Political | 5 ุฃ ุจุงูุฑ ูู ุชุฑุงูุจ 
Not Political | 5 ุฃ ูุงููู ููู ูู ุงูุงุฑุฏู ุญูุธ ุงููู ููููุฉ ุงูุฃุฑุฏู ุงูุดูููู ูุดุนุจูุง ุงูุบุงูู 
Not Political | 5 ุฃ ุนูุฏ ุงููู ุชุฌุชูุน ุงูุฎุตูู
 Political | 5 ุฃ ุงูุญูุฏููู ุนูู ูุนูุฉ ุงูุฅุฎูุงู ุงููุณูููู
Not Political | 5 ุฃ ููููุฑูู ููููุฑ ุงููู ูุงููู ุฎูุฑ ุงููุงูุฑูู
Political | 5 ุฃ ููุฐุง ุชู ุชูุซูู ุงููุณุฑุญูุฉ ูู ูุฌูุฏ ุงุณูุญุฉ ููู ุงูุงูุฑ ูุนุฑูู ููุงุฐุง ุงูุงุฎูุงู ูุฑูุจูููู ููุฐุง
Political | 5 ุฃ ุฃุนุทู ุฃูุฑ ูู ุชู ุฃุจูุจ ุงูููู ูููุฐ ุงูุฃูุฑ ููุทูุน ูุฐุง ูููู ุงูุฃุฑุฏู
Political | 5 ุฃ ูู ุชุฑุงูุจ ููุชููุงูู ูุจู ุฒุงูุฏ: ุจุฑุงูู ุงูุฃุฑุฏู
Political | 5 ุฃ ุชุตุฑูุญ ูุฒูุฑ ุงูุฎุงุฑุฌูุฉ 
Political | ุงุชุจุงุน ุณูุงุณุฉ ุชุฑุงูุจ ู ูุชููุงูู
Political | 5 ุฃ ุงูุฃุฑุฏู ุตููุนุฉ ุจุฑูุทุงููุฉ ูุญูุงูุฉ ูุตุงูุญ ุงููููู ุงูุฅุณุฑุงุฆููู.
Political | 5 ุฃ ุชูุงู ุตููููู ุดูุฑุง ุนูู ุงูุชูุถูุญ !!
Political | 5 ุฃ ุทูุจ ููุด ูุง ูู ููุฏูู ุฒู ูุงุฏ ุนุดุงู ุงูููุงู ูุนูู ููุณ ุงูููุฏูู ูููู ููุฌู ููููุงู ูุงูุฅุฎูุงู ูุน ุจุนุถ ูุด ููู ุจูููู ุนุฏู ุงูุซุฑ
Not Political | 5 ุฃ ููุญุฑูุฉ ุงูุญูุฑุงุก ุจุงุจ ุจูู ูุฏ ูุฏุฑุฌุฉ ูุฏู 
 Political | 5 ุฃ ุงูุชุฑุฌูุฉ: ุญุธุฑ ุงู ุฏุนูุฉ ููุชุธุงูุฑ ููุณุงูุฏุฉ ุบุฒุฉ
Not Political | 5 ุฃ ุญุฏุง ูุดุฑุญ ูู ุ
Not Political | 5 ุฃ ุงูุตูุงููุฉ ุณููุฏุญุฑูู ูุฑุฉ ูุงุญุฏุฉ ุฅูุฑุจุช 
Political | 5 ุฃ ููุงุฐุง ุนู ุงูุชุทุจูุน ุฃูุง ููุนุชุจุฑ ุฌุฑููุฉ ูุนุงูุจ ุนูููุง ุงููุงููู ุุุุ@ููู ูุง ุชุณุชุนุฌููุง. ูู ุฌุฑููุฉ ูุนุงูุจูู ุนูููุง ุงููุงููู ุงูุฅููู.
Political | 5 ุฃ ุจุงูุชุงุฑูุฎ ุงูุญุฏูุซ ุฏุงุฆูุง ุงูููุชูู ุงูุญุฑูุงุช ุงูุงุณูุงููู ุงูุงู ูุงูุช ุ ุนูุฑู ูุง ุดูุช ุงู ุงุชูุงู ูููุจุฑุงููู ุงู ุงูุดููุนูู.. ุงู ุงูุจุนุซูู ุงูุชู ุฃุจุฏุนุช ูู ุนูู ุงููุฌุงุฒุฑ ูู ุดุนูุจูุง ุนูุฏูุง ุงุณุชููุช ุงูููุงุตุจ ูู ุฏูููุง
Political | ูู ุชุชููุน ุงูู ุงูู ูู ุงูุงุฑุฏู ุงูุถู ุ!!!
Not Political | 5 ุฃ ุงููู ูุญูุธ ุงูุฃุฑุฏู ูู ูู ุดุฑ
Political | 5 ุฃ ุงูุฃูุงูุฑ ุงูุฃูุฑูููุฉ ูุตูุช ..ููุง ุจุฏ ูู ูุฑูุงู ุนูู ุฃูู ุงูุฃุฑุฏู ูู ุนูุงู .
Political | 5 ุฃ ูุง ููููู ูู ุงููู ููู ุงูุญุณุงุจโฆ ููุณุทูู ูุถูุชูุง ูููุง ู ุงูููุฑูุถ ูุฌุชูุนูุง ูู ุงูุฌููุด ูุญุงุฑุจูุง ุงูุตูุงููุฉโฆ ูุด ุงูุนูุณ
 Political | 5 ุฃ ูุง ุนุดุชูุง ุฑุฌุงู ููุง ุฎููุชูุง ุงูุฑุฌุงู ุชุนูุด
 Political | 5 ุฃ ููุงุญุธูู ูู ุงูุฏูู ุชุฏุนู ูุชุญุงูุธ ุนูู ุงูู ุงุณุฑุงุฆูู ูููู ุจุฏูููุง
 Political | 5 ุฃ ุญุงูู ุญุฏูุฏ ุงูุงุญุชูุงู
Political | 5 ุฃ ูุงููู ุทูุนุช ุงูุฃุฑุฏู ูุญุชูุฉ ุฃูุซุฑ ูู ููุณุทูู ูุง ุจุฏ ูู ุชุญุฑูุฑ ุงููุดุงูู ูู ููููุฉ ุงูุตูุงููุฉ 
Not Political | 5 ุฃ ูููุง ููุณูุชูููู ุงููููุงุนูุฏูููู ูููู ุงููููุคูููููููู ุบูููุฑู ุฃููููู ุงูุถููุฑูุฑู ููุงููููุฌูุงููุฏูููู ููู ุณูุจูููู ุงูููููู ุจูุฃูููููุงูููููู ููุฃููููุณููููู  ููุถูููู ุงูููููู ุงููููุฌูุงููุฏูููู ุจูุฃูููููุงูููููู ููุฃููููุณููููู ุนูููู ุงููููุงุนูุฏูููู ุฏูุฑูุฌูุฉู  ูููููููุง ููุนูุฏู ุงูููููู ุงููุญูุณูููููฐ  ููููุถูููู ุงูููููู ุงููููุฌูุงููุฏูููู ุนูููู ุงููููุงุนูุฏูููู ุฃูุฌูุฑูุง ุนูุธููููุง
 Political | 5 ุฃ ุงูุงุฑุฏู ุชุตุฑุญ ูุชุชููู ุจุฅุณู ุฅุณุฑุงุฆูู
Political | 5 ุฃ ุงูุงุฎูุงู ุงููุณูููู ูุณุจุจูู ููู ุฑุนุจ ุงูุชุฑ ูู ุงูุตูุงููุฉ ุ ุฅุณุฑุงุฆูู ูุจุณูุทู ูููู
Political | 5 ุฃ ูุทุฑุฏ ุงูุณููุฑ ุงูุฅุณุฑุงุฆููู โ ูุญุธุฑ ุงูุฃุฎูุงู ุงููุณูููู โ
Political | 5 ุฃ ุฌูุด ูุชููุงูู ูุฑุน ุงูุฃุฑุฏู
Not Political | 5 ุฃ ุงูุญูุฏููู ููุง ุญูู ููุง ููุฉ ุงูุง ุจุงููู
Not Political | 5 ุฃ ุฅู ุงูุญูู ุฅูุง ููู.. ูุฎุงููุฉ ุงูููุงููู ูุด ูุนูุงุฑ.. ุงููุนูุงุฑ ูู ุงูุชุฒุงุฌ ูุฑุงุฑุงุชูู ุจุงูุดุฑูุนุฉ ุงู ุงููููุฑ ุนููุง ุ ููุง ุงุนุชูุฏ ุงูู ูู ุทุฑุญ ุจุฏูู ููุงุณูุงู ูุงููุง ุงุฌุชุซุงุซ ููุงุณูุงู ุจุฐุฑูุนุฉ ุงูุงุฎูุงู
Not Political | 5 ุฃ ุงูุญูุฏููู ุนูู ูุฌูุฏ ุงููู
Not Political | ุงูุญูุฏููู ุนูู ูุฌูุฏ ูุญููุฉ ุฅูููุฉ ุชูุชุต ูุชุฃุฎุฐ ุญู ุงูุนุจุงุฏ ูู ุงูุนุจุงุฏ
Not Political | ุงูุญูุงุฉ ูุตูุฑุฉ ููุญู ูุด ูุฎูุฏูู ูููุง ุขุฎุฑูุง ูุจุฑ ูุชุฑ ุจูุชุฑ ุณูุณุฃู ุงูุงู ุงููู ุนู ูู ุตุบูุฑุฉ ููุจูุฑุฉ
Not Political | ูุนูุฏ ุงููู ุชุฌุชูุน ุงูุฎุตูู
Political | 5 ุฃ ููู ุงูุงุฑุฏู ูุณุชูุฑุฏ ุงูุฎุถุฑ ูู ุงุณุฑุงุฆูู ููุชููู ูุณุงุนุฏุงุช ูุงููุฉ ูู ุนุงู ูู ุงูุฑููุง ุญุชู ูุง ูุฎุฑุฌ ุงูุดุนุจ ุงูุงุฑุฏูู ููุดูุงุฑุน ููููู " ุงูุดุนุจ ูุฑูุฏ ุงุณูุงุท ุงููุธุงู "
Political | 5 ุฃ ูู ูู ูุฑุฉ ู ูู ูููู ุงูุฃุฎูุงู ุงููุณูููู ูุซุจุชูู ุฃููู ูู ุนูู ุญู ูุง ุบูุฑูู
Political | 5 ุฃ ูุงูุชุนุฑู ุงูุงูุฉ ุงูุงุณูุงูู ุงู ุงูุงุฎูุงู ูู ูุญุฏูู ูุฏุงูุนูู ุนู ูุฐ ุงูุงูุฉ
 Political | 5 ุฃ ุงูุญูุฏููู ุนูู ูุฌูุฏ ุงูุฌูุงุนุฉ ุงูุงุฎูุงู ูุฃููู ุงููุญูุฏูู ุงููุงุฏุฑูู ุนูู ุฅุณูุงุทูู ุจุงุฐู ุงููู ุทุงู ุงูุฒูู ุฃู ูุตุฑ
 Political | 5 ุฃ ูุงููู ูุง ุญุฏ ููุญู ุบูุฑู ุฃูุช ูุงูููู ุชุงุนู
 Political | 5 ุฃ ูููู ูุฒูุฑ ุงูุฏุงุฎููุฉ ุงูุตููููู
Political | 5 ุฃ ูุงุนุชุจุงุฑ ุงู ูุดุงุท ูููู ุจู ุงูุตูุงููู ุนูู ูุดุฑูุน ูุงูุฐุง ุงูุฐู
Political | 5 ุฃ ุงูููููุฉ ุงูุงุฑุฏููู ุงูุตูููููุฉ ุ ุจููุงุฏุฉ ููู ุงูุจูุฏูุฑุฉ.
Not Political | 5 ุฃ ุณูุงุฏุฉ ุงูุงุฑุฏู ููู ูู ุดูุก
Not Political | 5 ุฃ ๐ฏ๐ด๐ฏ๐ดโค๏ธ
Not Political | 5 ุฃ ูุงููู ูููุง ุจุชูุดู ูุฑุง ูุตูุญุชูุง ูุงูููู ุงูุงุฎูุงู
Not Political | 5 ุฃ ุณูุงุฏุฉ ุงูุฃุฑุฏู ูุงููุงููู ููู ููุดู
Not Political | 5 ุฃ ูุฑุงุฑ ุณููู ููููู ุฌุงุก ูุชุฃุฎุฑ ุฌุฏุง
Not Political | 5 ุฃ ๐ฏ๐ด๐ฅ๐ฏ๐ด๐ฅ๐ฏ๐ด๐ฅ๐ฏ๐ด๐๐๐๐
Not Political | 5 A ๐ฏ๐ด๐ฏ๐ด๐ฏ๐ด๐ฏ๐ด๐ฏ๐ด๐ฏ๐ด๐ฏ๐ด๐ซก๐ซก๐ซก๐ซก๐ซก๐ซก๐ซก๐ซก๐ซก๐ฏ๐ด๐ฏ๐ด๐ฏ๐ด๐ฏ๐ด๐ฏ๐ด๐ฏ๐ด๐ฏ๐ด๐ซก๐ซก๐ซก๐ซก
Not Political | 5 A ุงูุญูุฏ ููู ุชุนุงูู ุนูู ูุฐุง ุงููุฑุงุฑ ุงูุฌููู ูุนููุง ุฎุทุฑูู ูุจูุฑ ุนูู ุงูุฏูู ูุงูุฏููุง
 Political | 5 A ูุงููุง ุงูุฌุจุช ูุดุฑุนุช ุงูุฌูุงุฏ ุงุตุฏุฑุชู ุญูููู
Political | 5 A ุญุชุง ุงููุณูููู ุตุงุฑู ูุญุงุฑุจู ุงูุฏูู
Not Political | 5 A ๐๐๐๐๐๐๐ ุงูุดูุณ ูุง ุจุชุชุบุทู ุจุบุฑุจุงู
Not Political | 5 A deneme
 Political | 5 A ูููุฏ ุฎูุจุฑ ุงูุธูู ูุคุฐู ุจุฎุฑุงุจูู ุจุงุฐู ุงููู
Not Political | 5 A ุญุณุจูุง ุงููู ููุนู ุงููููู
Not Political | 5 A ูู ุชุฑุถู ุนูู ุงููููุฏ ููุง ุงููุตุงุฑู ุญุชู ุชุชุจุน ููุชูู

"""

@app.post("/analyze")
async def analyze(comment: CommentRequest):
    text = comment.text.strip()
    if not text:
        raise HTTPException(status_code=400, detail="Empty comment text.")

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": SYSTEM_INSTRUCTIONS},
                {"role": "user", "content": f"Classify this comment as 1 or 0: \"{text}\""}
            ],
            temperature=0,
            max_tokens=1,
        )

        classification = response.choices[0].message.content.strip()

        if classification not in {"0", "1"}:
            logger.warning(f"Unexpected classification response: {classification}")
            classification = "0"  # safe fallback

        is_political = classification == "1"

        return {
            "label": classification,
            "is_political": is_political,
            "text_sample": text[:50],
            "status": "ok"
        }

    except Exception as e:
        logger.error(f"OpenAI API error: {e}")
        raise HTTPException(status_code=500, detail="Internal server error.")

@app.get("/health")
async def health():
    return {"status": "OK", "openai_key_set": bool(OPENAI_API_KEY)}